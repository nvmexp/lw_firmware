#!/usr/bin/perl
#
# _LWRM_COPYRIGHT_BEGIN_
#
# Copyright 2021 by LWPU Corporation.  All rights reserved.  All
# information contained herein is proprietary and confidential to LWPU
# Corporation.  Any use, reproduction, or disclosure without the written
# permission of LWPU Corporation is prohibited.
#
# _LWRM_COPYRIGHT_END_
#
use File::Basename;

if (($#ARGV + 1) != 1) {
    die "Please pass the combined_image.bin as an arg to this file!";
}

my $imageBin = $ARGV[0];

if ($imageBin !~ /^(.*)_image.bin$/) {
    die "Wrong file passed!";
}

my $imagePrefix = $1;
my $outputFile = $imagePrefix .".h";
my $descFile = $imagePrefix . "_desc.h";

open(BIN_FILE, $imageBin) or die "$!";
open(OUTPUT_FILE, '>', $outputFile) or die "$!";
open(DESC_FILE, $descFile) or die "$!";

my $hdrGuard = uc basename($imagePrefix);
$hdrGuard = "_" . $hdrGuard . "_";

print OUTPUT_FILE "/*
 * Copyright 2021 by LWPU Corporation.  All rights reserved.  All
 * information contained herein is proprietary and confidential to LWPU
 * Corporation.  Any use, reproduction, or disclosure without the written
 * permission of LWPU Corporation is prohibited.
 */";

print OUTPUT_FILE "\n\n#ifndef $hdrGuard\n#define $hdrGuard\n\n";

print OUTPUT_FILE "// DO NOT EDIT - THIS FILE WAS AUTOMATICALLY GENERATED BY " .basename($0). "\n\n";

# Output descriptor (shortlwt: just use the .h file directly)
my $startPrint = 0;
while (<DESC_FILE>) {
    if ($startPrint || ($_ =~ /^#include/)) {
        print OUTPUT_FILE $_;
        $startPrint = 1;
    }
}

# Output bin data
local $/; # for reading .bin file properly
my $varName = basename($imagePrefix) . "_image";

print OUTPUT_FILE "\nconst LwU32 " . $varName . "[] = {\n";

my $unp = unpack "H*", <BIN_FILE>;
my $binSize = length($unp) / 2; # Colwert hex digit count (half-bytes) to byte count
$unp =~ s/(.{64})/$1\n/mxsg;
$unp = lc $unp;
$unp =~ s/([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})/ 0x$4$3$2$1,/mxsg;
print OUTPUT_FILE $unp;

print OUTPUT_FILE "};\n";

print OUTPUT_FILE "\nconst LwU32 " . $varName . "_size = $binSize; /* bytes */\n";

print OUTPUT_FILE "\n#endif // $hdrGuard\n";